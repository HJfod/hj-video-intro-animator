<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'/>
<title>your cool intro</title>
<style>
body {
	margin: 0;
	padding: 0;
	position: absolute;
	overflow: hidden;
}
</style>
</head>
<body>
<canvas width='1920' height='1080' id='can' onclick=''></canvas>
<script>
const canvas = document.getElementById('can');
const ctx = canvas.getContext('2d');

canvas.style.backgroundColor = '#000000';

let text = [];
let frame = 0;
let input_word = [];	// text, size, glow, position, brightness
let s = { expand: .7, base: .03 };
let a = { type: 'fade', lgt: 50 };
let e = [];
let ease = { c: 1.05, h: 3 };	// curve, backholder
let bg = { w: canvas.width/2, c: 'rgb(0,0,0)', bc: 10 };
let global = { glow_o: 1, font: 'Roboto', debug: false, duration: 3, render: false, rendered: false };
let rendered = [];

console.log(window.innerWidth + ',' + window.innerHeight);

function alg(i,t) {
	return text[t].w * i + text[t].w * (input_word[t][0].split('').length/2) + text[t].w/2 - input_word[t][0].split('').length * text[t].w;
}

function rov(obj) {	// return object values
	let str = '';
	for (let i = 0; i < Object.keys(obj).length; i++){
		if (Object.values(obj)[i].constructor === Array) continue;
		str += (Object.keys(obj)[i] + ': ' + Object.values(obj)[i] + ', ');
	}
	return str;
}

function animation(goal) {
	switch (a.type) {
		case 'fade':
			if (a.lgt - frame < 0){
				return goal;
			}else{
				return (a.lgt - frame) / goal;
			}
			break;
	}
}

function effects(){
	for (let i = 0; i < e.length; i++){
		switch (e[i]){
			case 'flicker':
				global.glow_o = Math.random()*.5+.5;
				break;
		}
	}
}

function render() {
	return new Promise((resolve,reject) => {
		rendered[frame] = new Image();
		rendered[frame].src = canvas.toDataURL();
		if (frame == global.duration*60){
			global.rendered = true;
			frame = 0;
			global.render = false;
			resolve(true);
		}
		resolve(false);
	});
}

function init() {
	let url = new URL(window.location.href);
	
	console.log(url.searchParams.get('length'));
	
	global.font = localStorage.getItem('font');
	global.debug = localStorage.getItem('debug');
	global.render = localStorage.getItem('render');
	global.duration = localStorage.getItem('length');
	
	e = localStorage.getItem('effects').split('||');
	
	ease.c = localStorage.getItem('ease_c');
	ease.h = localStorage.getItem('ease_h');
	
	bg.bc = localStorage.getItem('bg_bright');
	
	console.log(bg.bc);
	
	for (let i = 0; i < url.searchParams.get('length'); i++){
		let t = localStorage.getItem('input_text_'+i).split('_sep_');
		input_word[i] = [ t[0],Number(t[1]),Number(t[2]),Number(t[3]),Number(t[4]),Number(t[5]) ];
	}
	
	for (let j = 0; j < input_word.length; j++){
		text[j] = { txt: [], x: canvas.width/2, y: canvas.height/2, w: input_word[j][5], w_o: input_word[j][5], s: 1 }
		console.log(j);
		
		for (let i = 0; i < input_word[j][0].split('').length; i++){
			text[j].txt[i] = {t: input_word[j][0][i], x: alg(i,j), y: 0+input_word[j][3], a: 1, b: input_word[j][4] };
		}
	}
}

function loop() {
	if (frame < global.duration*60){
		frame += 1;
	}else{
		if (global.rendered){
			frame = 1;
		}else{
			return;
		}
	}
	
	canvas.width = window.innerWidth;
	canvas.height = window.innerHeight;
	
	if (global.rendered){
		
		ctx.fillStyle = '#000';
		ctx.fillRect(0,0,canvas.width,canvas.height);
		ctx.drawImage(rendered[frame],canvas.width/4,canvas.height/4,canvas.width/2,canvas.height/2);
		ctx.fillStyle = '#fff';
		ctx.font = '40px Bebas Neue';
		ctx.textAlign = 'center';
		ctx.fillText('Finished video:',canvas.width/2,canvas.height/5);
		ctx.fillText('Press L to Download',canvas.width/2,canvas.height/1.2);
		
	}else{
		
		/*   background   */
		
		let bg_a = Math.log(frame)*bg.bc+bg.bc;
		let bg_grad = ctx.createRadialGradient(canvas.width/2,canvas.height/2,0,canvas.width/2,canvas.height/2,bg.w);
		bg_grad.addColorStop(0,'rgb('+bg_a+','+bg_a+','+bg_a+')');
		bg_grad.addColorStop(1,bg.c);
		
		ctx.fillStyle = bg_grad;
		ctx.fillRect(0,0,canvas.width,canvas.height);
		
		for (let j = 0; j < text.length; j++){
			text[j].x = canvas.width/2;
			text[j].y = canvas.height/2;
			
			/*   text   */
			
			for (let i = 0; i < text[j].txt.length; i++){
				ctx.font = input_word[j][1] + text[j].s + 'px ' + global.font;
				ctx.textAlign = 'center';
				text[j].txt[i].x = alg(i,j);
				if (input_word[j][2]){
					ctx.filter = 'blur('+input_word[j][2]+'px)';
					ctx.fillStyle = 'rgba('+text[j].txt[i].b+','+text[j].txt[i].b+','+text[j].txt[i].b+','+global.glow_o+')';
					ctx.fillText(text[j].txt[i].t,text[j].x + text[j].txt[i].x, text[j].y + text[j].txt[i].y);
					ctx.filter = 'none';
				}
				ctx.fillStyle = 'rgba('+text[j].txt[i].b+','+text[j].txt[i].b+','+text[j].txt[i].b+','+animation(text[j].txt[i].a)+')';
				ctx.fillText(text[j].txt[i].t,text[j].x + text[j].txt[i].x, text[j].y + text[j].txt[i].y);
			}
			
			/*   move text   */
			
			text[j].w = text[j].w_o + (Math.log(frame + 1) / Math.log(ease.c)) / ease.h;
			
			/*   effects   */
			
			if (e.length){
				effects();
			}
			
			/*   debug   */
			
			console.log(global.debug);
			
			if (global.debug === 'true'){
				let dtxt = '';
				dtxt += 'Frame: ' + frame + '/' + global.duration*60 + '\n';
				dtxt += 'length: ' + global.duration + 's' + '\n';
				dtxt += 'input_word: ' + input_word + '\n';
				for (i = 0; i < text.length; i++){
					dtxt += 'text' + i + ': ' + rov(text[i]) + '\n';
				}
				dtxt += 's: ' + rov(s) + '\n';
				dtxt += 'a: ' + rov(a) + '\n';
				dtxt += 'ease: ' + rov(ease) + '\n';
				dtxt += 'bg: ' + rov(bg) + '\n';
				dtxt += 'global: ' + rov(global) + '\n';
				
				ctx.fillStyle = 'rgb(0,255,0)';
				ctx.font = '12px Arial';
				ctx.textAlign = 'left';
				
				dtxt = dtxt.split('\n');
				for (let i = 0; i < dtxt.length; i++){
					ctx.fillText(dtxt[i],32,32+i*16);
				}
			}
		}
	}
	
	if (global.render === 'true'){
		render().then((value) => {
			if (value){
				alert('el finisho');
				loop();
			}else{
				requestAnimationFrame(loop);
			}
		}).catch((value) => {
			alert(value);
		});
	}else{
		requestAnimationFrame(loop);
	}
}
init();
loop();
</script>
</body>
</html>
